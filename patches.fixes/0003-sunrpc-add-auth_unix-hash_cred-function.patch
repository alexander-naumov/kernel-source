From: Frank Sorenson <sorenson@redhat.com>
Date: Thu, 29 Sep 2016 10:44:39 -0500
Subject: [PATCH] sunrpc: add auth_unix hash_cred() function
Git-commit: 1e035d065f3415809c056fb7537320a74c718537
Patch-mainline: v4.9
References: bsc#1012917

Add a hash_cred() function for auth_unix, using both the
uid and gid from the auth_cred.

Signed-off-by: Frank Sorenson <sorenson@redhat.com>
Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
Acked-by: NeilBrown <neilb@suse.com>

---
 net/sunrpc/auth_unix.c |   11 +++++++++++
 1 file changed, 11 insertions(+)

--- a/net/sunrpc/auth_unix.c
+++ b/net/sunrpc/auth_unix.c
@@ -13,6 +13,7 @@
 #include <linux/sunrpc/clnt.h>
 #include <linux/sunrpc/auth.h>
 #include <linux/user_namespace.h>
+#include <linux/hash.h>
 
 #define NFS_NGROUPS	16
 
@@ -48,6 +49,15 @@ unx_destroy(struct rpc_auth *auth)
 	rpcauth_clear_credcache(auth->au_credcache);
 }
 
+static int
+unx_hash_cred(struct auth_cred *acred, unsigned int hashbits)
+{
+	u64 uid = from_kuid(&init_user_ns, acred->uid);
+	u64 gid = from_kgid(&init_user_ns, acred->gid);
+	return hash_64(gid | (uid << (sizeof(gid_t) * 8)),
+		       hashbits);
+}
+
 /*
  * Lookup AUTH_UNIX creds for current process
  */
@@ -222,6 +232,7 @@ const struct rpc_authops authunix_ops =
 	.au_name	= "UNIX",
 	.create		= unx_create,
 	.destroy	= unx_destroy,
+	.hash_cred	= unx_hash_cred,
 	.lookup_cred	= unx_lookup_cred,
 	.crcreate	= unx_create_cred,
 };
